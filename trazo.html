<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Pauta Lamela ‚Äî pr√°ctica de trazos</title>

<link rel="preload" href="escolar_G.woff2" as="font" type="font/woff2" crossorigin>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>'>

<style>
  @font-face{
    font-family: 'EscolarG';
    src: url('escolar_G.woff2') format('woff2');
    font-display: swap;
  }
  :root{
    --bg:#f3f4f6;           /* mesa gris */
    --paper-shadow: rgba(0,0,0,.15);
    --divide:#e5e7eb;
    --pill:#f8fafc; --pill-border:#e5e7eb; --pill-hover:#eef2ff;

    /* Colores pauta */
    --base:#ef4444; --sec:#3b82f6; --margin:#10b981;

    /* Agujeros (anillado) */
    --pitch-mm: 12;   /* separaci√≥n entre agujeros */
    --holeD-mm: 4.2;  /* di√°metro del agujero */
    --offset-mm: 5.0; /* distancia del centro del agujero al borde del papel */
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    min-height:100vh;display:flex;flex-direction:column;
    background:var(--bg); /* solo mientras carga */
  }

  /* ===== Toolbar simple en dos filas ===== */
  header.toolbar{
    position:sticky; top:8px; z-index:10;
    margin:8px auto; max-width:1200px; width:calc(100% - 16px);
    background:#fff; border:1px solid var(--divide); border-radius:12px;
    box-shadow:0 6px 20px rgba(0,0,0,.08);
    padding:.45rem .55rem;
    display:flex; flex-wrap:wrap; gap:.5rem .75rem; align-items:center;
  }
  .group{display:flex; align-items:center; gap:.45rem}
  .gtitle{font-size:.78rem; font-weight:600; color:#374151; padding:0 .35rem}
  select,input[type="text"]{
    border:1px solid var(--pill-border);border-radius:999px;
    padding:.3rem .55rem;background:var(--pill);font-size:.9rem;outline:none;
  }
  input[type="range"]{ width:110px }
  button{
    border:1px solid var(--pill-border);border-radius:999px;background:var(--pill);
    padding:.35rem .55rem; cursor:pointer; transition:background .15s ease, transform .02s ease;
  }
  button:hover{background:var(--pill-hover)} button:active{transform:translateY(1px)}
  .icon{min-width:2rem}

  /* ===== Escenario / Hoja ===== */
  main{flex:1 1 auto;display:flex;justify-content:center;align-items:flex-start;overflow:auto;padding:8px}
  .paper{ position:relative; touch-action:none; }
  canvas{position:absolute;top:0;left:0;touch-action:none}
  #pautaCanvas{z-index:2;pointer-events:none}
  #drawCanvas {z-index:3}
  #ghostCanvas{z-index:4;pointer-events:none}
</style>
</head>
<body>

<header class="toolbar" role="toolbar" aria-label="Barra de herramientas">
  <!-- Archivo -->
  <div class="group">
    <span class="gtitle">Archivo</span>
    <button id="savePng"  class="icon" title="Guardar PNG">üíæ</button>
    <button id="printPdf" class="icon" title="Imprimir / PDF">üñ®Ô∏è</button>
    <button id="clear"    class="icon" title="Limpiar">üóëÔ∏è</button>
  </div>

  <!-- Edici√≥n -->
  <div class="group">
    <span class="gtitle">Edici√≥n</span>
    <select id="tool" title="Herramienta">
      <option value="pen" selected>‚úèÔ∏è L√°piz</option>
      <option value="eraser">ü©π Goma</option>
    </select>
    <label title="Grosor del trazo">
      <!-- Trazo m√≠nimo por defecto -->
      <input id="penSize" type="range" min="1" max="64" value="1" />
    </label>
    <button id="undo" class="icon" title="Deshacer">‚Ü∂</button>
    <button id="redo" class="icon" title="Rehacer">‚Ü∑</button>
  </div>

  <!-- Vista -->
  <div class="group">
    <span class="gtitle">Vista</span>
    <button id="zoomIn" class="icon" title="Acercar">Ôºã</button>
    <button id="zoomOut" class="icon" title="Alejar">Ôºç</button>
    <button id="zoomReset" class="icon" title="Restablecer">‚ü≤</button>
    <label title="Modo Pan"><input type="checkbox" id="panMode" /> Pan</label>
  </div>

  <!-- Pauta -->
  <div class="group">
    <span class="gtitle">Pauta</span>
    <select id="pautaStep" title="Paso (mm)">
      <option value="2.5">2.5 mm</option>
      <option value="3">3 mm</option>
      <option value="4" selected>4 mm</option>
    </select>
    <select id="margenSel" title="Margen (mm)">
      <option value="0">Sin margen</option>
      <option value="10">10 mm</option>
      <option value="15" selected>15 mm</option>
    </select>
    <select id="colorPauta" title="Color">
      <option value="clasica">Cl√°sica</option>
      <option value="suave" selected>Suave</option>
      <option value="alto">Alto contraste</option>
    </select>
    <label title="Mostrar pauta"><input type="checkbox" id="showPauta" checked/> P</label>
    <label title="Mostrar cuadr√≠cula"><input type="checkbox" id="showGrid" checked/> ‚òê</label>
    <button id="redraw" class="icon" title="Redibujar">üîÑ</button>
  </div>

  <!-- Gu√≠a -->
  <div class="group">
    <span class="gtitle">Gu√≠a</span>
    <select id="ghostSelect" title="Letra gu√≠a">
      <optgroup label="Min√∫sculas">
        <option>a</option><option>b</option><option>c</option><option>d</option><option>e</option>
        <option>f</option><option>g</option><option>h</option><option>i</option><option>j</option>
        <option>k</option><option>l</option><option>m</option><option>n</option><option>√±</option>
        <option>o</option><option>p</option><option>q</option><option>r</option><option>s</option>
        <option>t</option><option>u</option><option>v</option><option>w</option><option>x</option>
        <option>y</option><option>z</option>
      </optgroup>
      <optgroup label="May√∫sculas">
        <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option>
        <option>F</option><option>G</option><option>H</option><option>I</option><option>J</option>
        <option>K</option><option>L</option><option>M</option><option>N</option><option>√ë</option>
        <option>O</option><option>P</option><option>Q</option><option>R</option><option>S</option>
        <option>T</option><option>U</option><option>V</option><option>W</option><option>X</option>
        <option>Y</option><option>Z</option>
      </optgroup>
      <optgroup label="Opciones">
        <option value="__custom__">Libre (texto)</option>
        <option value="__none__">Ocultar gu√≠a</option>
      </optgroup>
    </select>
    <input id="ghostText" type="text" placeholder="Escribe‚Ä¶" style="display:none;width:10rem" title="Texto libre" />
    <input id="ghostSize" type="range" min="40" max="300" value="40" title="Tama√±o gu√≠a" />
    <select id="viaIndex" title="V√≠a">
      <option value="1">1¬™</option>
      <option value="2" selected>2¬™</option>
      <option value="3">3¬™</option>
      <option value="4">4¬™</option>
      <option value="5">5¬™</option>
    </select>
    <label title="Mostrar gu√≠a"><input type="checkbox" id="ghostShow" checked/> üëÅÔ∏è</label>
    <label title="Palabra en l√≠nea"><input type="checkbox" id="inlineWord" checked/> ‚â°</label>
  </div>

  <!-- Anilla -->
  <div class="group">
    <span class="gtitle">Anilla</span>
    <select id="ringSide" title="Lado">
      <option value="left" selected>Izq.</option>
      <option value="right">Der.</option>
    </select>
  </div>
</header>

<main>
  <div id="paper" class="paper">
    <canvas id="pautaCanvas"></canvas>  <!-- mesa + folio + cuadr√≠cula + pauta + agujeros -->
    <canvas id="drawCanvas"></canvas>
    <canvas id="ghostCanvas"></canvas>
  </div>
</main>

<script>
(()=>{
  // ===== Utilidades =====
  const DPR=Math.max(1,window.devicePixelRatio||1);
  const mm2px=mm=>mm*96/25.4*DPR, px2css=px=>(px/DPR)+'px';
  const A4={w:mm2px(210),h:mm2px(297)};
  const RADIUS_CSS=12, RADIUS=RADIUS_CSS*DPR;

  // Fecha
  const formatTodayEs=()=>new Intl.DateTimeFormat('es-ES',{day:'numeric',month:'long',year:'numeric'}).format(new Date());
  const getHeaderText=()=>`Granada ‚Äî ${formatTodayEs()}`;

  // Fuente
  let escolarReady=null;
  function waitEscolar(){
    if(!escolarReady){
      if(document.fonts && document.fonts.load){
        escolarReady=Promise.all([document.fonts.load('16px "EscolarG"'), document.fonts.ready]).catch(()=>{});
      }else escolarReady=new Promise(r=>setTimeout(r,200));
    }
    return escolarReady;
  }

  // DOM
  const paper=document.getElementById('paper');
  const pauta=document.getElementById('pautaCanvas');
  const draw =document.getElementById('drawCanvas');
  const ghost=document.getElementById('ghostCanvas');
  const cvs=[pauta,draw,ghost];

  // Controles
  const stepSel=document.getElementById('pautaStep');
  const margenSel=document.getElementById('margenSel');
  const colorSel=document.getElementById('colorPauta');
  const showPauta=document.getElementById('showPauta');
  const showGrid=document.getElementById('showGrid');
  const redrawBtn=document.getElementById('redraw');

  const ghostSelect=document.getElementById('ghostSelect');
  const ghostText=document.getElementById('ghostText');
  const ghostSize=document.getElementById('ghostSize');
  const ghostShow=document.getElementById('ghostShow');
  const inlineWord=document.getElementById('inlineWord');
  const viaIndex=document.getElementById('viaIndex');

  const toolSel=document.getElementById('tool');
  const penSize=document.getElementById('penSize');
  const undoBtn=document.getElementById('undo');
  const redoBtn=document.getElementById('redo');
  const clearBtn=document.getElementById('clear');
  const savePngBtn=document.getElementById('savePng');
  const printPdfBtn=document.getElementById('printPdf');

  const zoomInBtn=document.getElementById('zoomIn');
  const zoomOutBtn=document.getElementById('zoomOut');
  const zoomResetBtn=document.getElementById('zoomReset');
  const panMode=document.getElementById('panMode');
  const ringSideSel=document.getElementById('ringSide');

  // Paletas
  function palette(mode){
    if(mode==='suave') return {base:'#f87171', sec:'#93c5fd', margin:'#22c55e'};
    if(mode==='alto')  return {base:'#dc2626', sec:'#1d4ed8', margin:'#16a34a'};
    return {base:'#ef4444', sec:'#3b82f6', margin:'#10b981'};
  }

  // ===== Vista (zoom/pan con l√≠mites) =====
  let viewScale=1, viewOffsetX=0, viewOffsetY=0; // coords documento

  function withView(ctx, drawFn){
    ctx.save();
    ctx.setTransform(viewScale,0,0,viewScale, -viewOffsetX*viewScale, -viewOffsetY*viewScale);
    drawFn(ctx);
    ctx.restore();
  }
  function roundedRectPath(ctx,x,y,w,h,r){
    const rr=Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y, x+w,y+h, rr);
    ctx.arcTo(x+w,y+h, x,y+h, rr);
    ctx.arcTo(x,y+h, x,y, rr);
    ctx.arcTo(x,y, x+w,y, rr);
    ctx.closePath();
  }
  function clamp(v,a,b){return Math.min(b,Math.max(a,v));}

  // Mant√©n la hoja dentro del canvas (no permitir vac√≠os grises ‚Äúpor encima‚Äù)
  function clampView(){
    const vw = A4.w / viewScale;
    const vh = A4.h / viewScale;
    if (vw <= A4.w){
      viewOffsetX = clamp(viewOffsetX, 0, A4.w - vw);
    }else{
      viewOffsetX = (A4.w - vw)/2; // centrar cuando est√° m√°s peque√±a que el lienzo
    }
    if (vh <= A4.h){
      viewOffsetY = clamp(viewOffsetY, 0, A4.h - vh);
    }else{
      viewOffsetY = (A4.h - vh)/2;
    }
  }

  function applyViewRedraw(){ drawPauta(); drawGuide(); redrawDrawLayer(); }

  function zoomBy(factor, focusDocX=A4.w/2, focusDocY=A4.h/2){
    const old=viewScale, next=clamp(old*factor,0.3,4); if(next===old) return;
    // mantener el foco
    const screenX=(focusDocX-viewOffsetX)*old, screenY=(focusDocY-viewOffsetY)*old;
    viewScale=next;
    viewOffsetX=focusDocX - screenX/viewScale;
    viewOffsetY=focusDocY - screenY/viewScale;
    clampView();
    applyViewRedraw();
  }
  zoomInBtn.onclick=()=>zoomBy(1.15);
  zoomOutBtn.onclick=()=>zoomBy(1/1.15);
  zoomResetBtn.onclick=()=>{viewScale=1; viewOffsetX=0; viewOffsetY=0; clampView(); applyViewRedraw();};

  // Pan
  let panning=false, panStart={x:0,y:0}, startOff={x:0,y:0};
  paper.addEventListener('pointerdown', e=>{
    if(!panMode.checked) return;
    panning=true; panStart={x:e.clientX,y:e.clientY}; startOff={x:viewOffsetX,y:viewOffsetY};
    paper.setPointerCapture?.(e.pointerId); e.preventDefault();
  });
  paper.addEventListener('pointermove', e=>{
    if(!panning) return;
    const dx=(e.clientX-panStart.x)/viewScale, dy=(e.clientY-panStart.y)/viewScale;
    viewOffsetX=startOff.x - dx; viewOffsetY=startOff.y - dy;
    clampView();
    applyViewRedraw();
  });
  const endPan=e=>{ if(!panning) return; panning=false; try{paper.releasePointerCapture(e.pointerId);}catch{} };
  paper.addEventListener('pointerup', endPan);
  paper.addEventListener('pointercancel', endPan);
  paper.addEventListener('pointerleave', endPan);

  // Ctrl + rueda = zoom al cursor
  document.addEventListener('wheel', e=>{
    if(!e.ctrlKey) return;
    e.preventDefault();
    const r=pauta.getBoundingClientRect();
    const xCanvas=(e.clientX-r.left)*(pauta.width/r.width);
    const yCanvas=(e.clientY-r.top) *(pauta.height/r.height);
    const fx = xCanvas/viewScale + viewOffsetX;
    const fy = yCanvas/viewScale + viewOffsetY;
    zoomBy(e.deltaY>0?1/1.08:1.08, fx, fy);
  }, {passive:false});

  // ===== Tama√±o hoja =====
  function sizePaper(){
    cvs.forEach(cv=>{
      cv.width=A4.w; cv.height=A4.h;
      cv.style.width=px2css(A4.w); cv.style.height=px2css(A4.h);
    });
    paper.style.width=px2css(A4.w);
    paper.style.height=px2css(A4.h);
  }

  // ===== Pauta + cuadr√≠cula + agujeros + ‚Äúfolio‚Äù + ‚Äúmesa‚Äù en el MISMO flujo =====
  function strokeH(ctx,y,w,c){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(A4.w,y); ctx.lineWidth=w; ctx.strokeStyle=c; ctx.stroke(); }
  function strokeV(ctx,x,w,c){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,A4.h); ctx.lineWidth=w; ctx.strokeStyle=c; ctx.stroke(); }

  function drawPauta(){
    const ctx=pauta.getContext('2d');
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,pauta.width,pauta.height);

    withView(ctx, (cv)=>{
      // (0) MESA gris detr√°s del folio y movi√©ndose con √©l (rect√°ngulo grande)
      const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() || '#f3f4f6';
      cv.fillStyle=bg;
      cv.fillRect(-A4.w, -A4.h, A4.w*3, A4.h*3); // grande para que no ‚Äúasome‚Äù nada

      // (1) Sombra del folio
      cv.save();
      roundedRectPath(cv, 0,0, A4.w,A4.h, RADIUS);
      cv.shadowColor='var(--paper-shadow)';
      cv.shadowBlur=12*DPR; cv.shadowOffsetY=4*DPR;
      cv.fillStyle='rgba(0,0,0,0.001)'; cv.fill();
      cv.restore();

      // (2) Fondo blanco + borde fino
      roundedRectPath(cv, 0,0, A4.w,A4.h, RADIUS);
      cv.fillStyle='#fff'; cv.fill();
      cv.lineWidth=1*DPR; cv.strokeStyle='rgba(0,0,0,.06)'; cv.stroke();

      // (3) Clip al folio
      roundedRectPath(cv, 0,0, A4.w,A4.h, RADIUS); cv.clip();

      const step=mm2px(parseFloat(stepSel.value));
      const top=20*DPR;
      const period=step*4.6;
      const marginPx=mm2px(parseFloat(margenSel.value)||0);

      const mode=colorSel.value;
      const base=(mode==='suave')?'#f87171':(mode==='alto')?'#dc2626':'var(--base)';
      const sec =(mode==='suave')?'#93c5fd':(mode==='alto')?'#1d4ed8':'var(--sec)';
      const marginC=(mode==='suave')?'#22c55e':(mode==='alto')?'#16a34a':'var(--margin)';

      pauta.dataset.topPad=String(top);
      pauta.dataset.step=String(step);
      pauta.dataset.period=String(period);
      pauta.dataset.margin=String(marginPx);

      // Cuadr√≠cula vertical desde el margen
      if(showGrid.checked){
        cv.save();
        cv.globalAlpha=0.15;
        cv.lineWidth=Math.max(0.75*DPR,0.5*DPR);
        let x=Math.max(0,marginPx);
        while(x<A4.w-1){ strokeV(cv,x,cv.lineWidth,sec); x+=step; }
        cv.restore();
      }

      // Pauta horizontal
      if(showPauta.checked){
        let y=top;
        while(y<pauta.height-top){
          strokeH(cv,y,1*DPR,sec); y+=step;        // ascendente
          strokeH(cv,y,1*DPR,sec); y+=step;        // techo
          strokeH(cv,y,1.5*DPR,base); y+=step;     // base roja
          strokeH(cv,y,1*DPR,sec); y+=step*1.6;    // descendente + espacio
        }
      }

      // Margen vertical
      if(marginPx>0){
        cv.beginPath(); cv.moveTo(marginPx,0); cv.lineTo(marginPx,pauta.height);
        cv.lineWidth=2*DPR; cv.strokeStyle=marginC; cv.stroke();
      }

      // Canto sombreado
      const side=ringSideSel.value;
      cv.save();
      const grad=cv.createLinearGradient(side==='left'?0: A4.w-4*DPR, 0, side==='left'?4*DPR: A4.w, 0);
      grad.addColorStop(0,'rgba(0,0,0,.10)'); grad.addColorStop(1,'rgba(0,0,0,0)');
      cv.fillStyle=grad;
      if(side==='left') cv.fillRect(0,0,4*DPR,A4.h); else cv.fillRect(A4.w-4*DPR,0,4*DPR,A4.h);
      cv.restore();

      // Agujeros (troquel)
      const pitch=mm2px(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pitch-mm'))||12);
      const holeR=mm2px(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--holeD-mm'))||4.2)/2;
      const offset=mm2px(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--offset-mm'))||5.0);
      const topPad=mm2px(12);
      const cx = (side==='left') ? offset : (A4.w - offset);

      // ‚ÄúQuitar‚Äù papel (perforar)
      cv.save();
      cv.globalCompositeOperation='destination-out';
      for(let y=topPad; y<=A4.h-topPad; y+=pitch){
        cv.beginPath(); cv.arc(cx,y,holeR,0,Math.PI*2); cv.fill();
      }
      cv.restore();

      // contorno + vi√±eteado
      for(let y=topPad; y<=A4.h-topPad; y+=pitch){
        cv.beginPath(); cv.arc(cx,y,Math.max(holeR-0.25*DPR,0),0,Math.PI*2);
        cv.lineWidth=0.75*DPR; cv.strokeStyle='rgba(0,0,0,.45)'; cv.globalAlpha=0.35; cv.stroke();
        const g=cv.createRadialGradient(cx,y, holeR*0.55, cx,y, holeR);
        g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,'rgba(0,0,0,.08)');
        cv.beginPath(); cv.arc(cx,y,holeR,0,Math.PI*2); cv.fillStyle=g; cv.fill();
      }
    });
  }

  // ===== Gu√≠a (cabecera + pr√°ctica) =====
  function currentGuideText(){
    const sel=ghostSelect.value;
    if(!ghostShow.checked || sel==='__none__') return '';
    if(sel==='__custom__') return (ghostText.value||'').trim();
    return sel;
  }
  function firstBaseLineY(){ const top=+pauta.dataset.topPad||20*DPR; const step=+pauta.dataset.step||mm2px(+stepSel.value); return top+2*step; }
  function baseLineForGuide(){ const step=+pauta.dataset.step||mm2px(+stepSel.value); const period=+pauta.dataset.period||step*4.6; const idx=+(viaIndex.value||2); return firstBaseLineY()+(idx-1)*period; }
  function marginXpx(){ return +pauta.dataset.margin || mm2px(+margenSel.value||0); }
  function stepPx(){ return +pauta.dataset.step || mm2px(+stepSel.value); }
  function startTextX(){ const m=marginXpx(); return (m>0?m:0)+stepPx(); }

  function drawHeaderLine(cv){
    const header=getHeaderText();
    const fontPx=Math.max(48*DPR, (+ghostSize.value)*0.55*DPR);
    cv.font=`normal ${fontPx}px "EscolarG", system-ui, sans-serif`;
    cv.textBaseline='alphabetic';
    cv.fillStyle='rgba(17,24,39,.40)';
    cv.strokeStyle='rgba(107,114,128,.55)';
    cv.lineWidth=Math.max(1,Math.round(fontPx*0.06));
    cv.fillText(header, startTextX(), firstBaseLineY());
    cv.strokeText(header, startTextX(), firstBaseLineY());
  }

  function drawGuide(){
    const ctx=ghost.getContext('2d');
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,ghost.width,ghost.height);

    withView(ctx, (cv)=>{
      roundedRectPath(cv, 0,0, A4.w,A4.h, RADIUS); cv.save(); cv.clip();

      drawHeaderLine(cv);

      const txt=currentGuideText(); if(!txt) { cv.restore(); return; }
      const fontPx=(+ghostSize.value)*DPR;
      cv.font=`normal ${fontPx}px "EscolarG", system-ui, sans-serif`;
      cv.textBaseline='alphabetic';
      cv.fillStyle='rgba(17,24,39,.28)';
      cv.strokeStyle='rgba(107,114,128,.6)';
      cv.lineWidth=Math.max(1,Math.round(fontPx*0.06));

      const baseY=baseLineForGuide();
      if(inlineWord.checked){
        let x=startTextX();
        for(const ch of txt){
          cv.fillText(ch,x,baseY);
          cv.strokeText(ch,x,baseY);
          x += cv.measureText(ch).width + fontPx*0.12;
        }
      }else{
        const total=cv.measureText(txt).width;
        cv.fillText(txt,(A4.w-total)/2,baseY);
        cv.strokeText(txt,(A4.w-total)/2,baseY);
      }
      cv.restore();
    });
  }

  // ===== Dibujo libre (grosor constante con zoom) =====
  const dctx=draw.getContext('2d'); dctx.lineCap='round'; dctx.lineJoin='round';
  let drawing=false, points=[]; const history=[]; let redoStack=[];

  function toolMode(){ return (toolSel.value==='eraser')?'destination-out':'source-over'; }
  function pointerDocPos(e){
    const r=draw.getBoundingClientRect();
    const xCanvas=(e.clientX-r.left)*(draw.width/r.width);
    const yCanvas=(e.clientY-r.top) *(draw.height/r.height);
    return { x:xCanvas/viewScale + viewOffsetX, y:yCanvas/viewScale + viewOffsetY };
  }

  function startDraw(e){
    if(panMode.checked) return;
    e.preventDefault(); drawing=true; redoStack.length=0;
    try{ draw.setPointerCapture(e.pointerId); }catch{}
    points=[pointerDocPos(e)];
    dctx.save(); dctx.globalCompositeOperation=toolMode();
    const size=(+penSize.value)*DPR;
    withView(dctx, (cv)=>{
      cv.beginPath(); cv.arc(points[0].x,points[0].y,(size/2)/viewScale,0,Math.PI*2);
      cv.fillStyle='#111'; cv.fill();
    });
  }
  function moveDraw(e){
    if(!drawing || panMode.checked) return;
    const p=pointerDocPos(e);
    const prev=points[points.length-1];
    points.push(p);
    const size=(+penSize.value)*DPR;
    withView(dctx, (cv)=>{
      cv.beginPath();
      cv.moveTo(prev.x,prev.y);
      cv.quadraticCurveTo(prev.x,prev.y,(prev.x+p.x)/2,(prev.y+p.y)/2);
      cv.lineWidth=size/viewScale; cv.strokeStyle='#111'; cv.stroke();
    });
  }
  function endDraw(e){
    if(!drawing) return;
    drawing=false;
    const size=(+penSize.value)*DPR;
    history.push([{mode:toolMode(), size, color:'#111', path:points.slice()}]);
    dctx.restore();
    try{ draw.releasePointerCapture(e?.pointerId); }catch{}
  }
  draw.addEventListener('pointerdown',startDraw);
  draw.addEventListener('pointermove',moveDraw);
  ['pointerup','pointerleave','pointercancel'].forEach(ev=>draw.addEventListener(ev,endDraw));

  function redrawDrawLayer(){
    dctx.setTransform(1,0,0,1,0,0);
    dctx.clearRect(0,0,draw.width,draw.height);
    withView(dctx, (cv)=>{
      roundedRectPath(cv, 0,0, A4.w,A4.h, RADIUS); cv.save(); cv.clip();

      const strokes=history.flat();
      strokes.forEach(s=>{
        cv.save(); cv.globalCompositeOperation=s.mode;
        if(s.path.length===1){
          const p=s.path[0];
          cv.beginPath(); cv.arc(p.x,p.y,(s.size/2)/viewScale,0,Math.PI*2);
          cv.fillStyle=s.color; cv.fill();
        }else{
          cv.beginPath();
          for(let i=0;i<s.path.length-1;i++){
            const a=s.path[i], b=s.path[i+1];
            if(i===0) cv.moveTo(a.x,a.y);
            cv.quadraticCurveTo(a.x,a.y,(a.x+b.x)/2,(a.y+b.y)/2);
          }
          cv.lineWidth=s.size/viewScale; cv.strokeStyle=s.color; cv.stroke();
        }
        cv.restore();
      });
      cv.restore();
    });
  }
  undoBtn.onclick=()=>{ if(!history.length) return; redoStack.push(history.pop()); redrawDrawLayer(); };
  redoBtn.onclick=()=>{ if(!redoStack.length) return; history.push(redoStack.pop()); redrawDrawLayer(); };
  clearBtn.onclick=()=>{ history.length=0; redoStack.length=0; redrawDrawLayer(); };

  // ===== Exportar (impresi√≥n limpia) =====
  function strokeH(o,y,w,c){ o.beginPath(); o.moveTo(0,y); o.lineTo(A4.w,y); o.lineWidth=w; o.strokeStyle=c; o.stroke(); }
  function strokeV(o,x,w,c){ o.beginPath(); o.moveTo(x,0); o.lineTo(x,A4.h); o.lineWidth=w; o.strokeStyle=c; o.stroke(); }

  function composeToCanvas(){
    const off=document.createElement('canvas'); off.width=A4.w; off.height=A4.h;
    const o=off.getContext('2d');

    // P√°gina limpia
    roundedRectPath(o, 0,0, A4.w,A4.h, RADIUS); o.save(); o.clip();
    o.fillStyle='#fff'; o.fillRect(0,0,off.width,off.height);

    const step=mm2px(+stepSel.value);
    const top =20*DPR;
    const mode=colorSel.value;
    const base = (mode==='suave')?'#f87171':(mode==='alto')?'#dc2626':'#ef4444';
    const sec  = (mode==='suave')?'#93c5fd':(mode==='alto')?'#1d4ed8':'#3b82f6';
    const marginC=(mode==='suave')?'#22c55e':(mode==='alto')?'#16a34a':'#10b981';
    const marginPx=mm2px(+margenSel.value||0);

    if(showGrid.checked){
      o.save(); o.globalAlpha=0.15; o.lineWidth=Math.max(0.75*DPR,0.5*DPR);
      let x=Math.max(0,marginPx); while(x<A4.w-1){ strokeV(o,x,o.lineWidth,sec); x+=step; }
      o.restore();
    }
    if(showPauta.checked){
      let y=top;
      while(y<A4.h-top){
        strokeH(o,y,1*DPR,sec); y+=step;
        strokeH(o,y,1*DPR,sec); y+=step;
        strokeH(o,y,1.5*DPR,base); y+=step;
        strokeH(o,y,1*DPR,sec); y+=step*1.6;
      }
      if(marginPx>0){
        o.beginPath(); o.moveTo(marginPx,0); o.lineTo(marginPx,A4.h);
        o.lineWidth=2*DPR; o.strokeStyle=marginC; o.stroke();
      }
    }

    // Cabecera
    (function(ctx){
      const baseY=top+2*step;
      const header=getHeaderText();
      const fontPx=Math.max(48*DPR, (+ghostSize.value)*0.55*DPR);
      ctx.save();
      ctx.font=`normal ${fontPx}px "EscolarG", system-ui, sans-serif`;
      ctx.textBaseline='alphabetic';
      ctx.fillStyle='rgba(17,24,39,.40)';
      ctx.strokeStyle='rgba(107,114,128,.55)';
      ctx.lineWidth=Math.max(1,Math.round(fontPx*0.06));
      let x=(marginPx>0?marginPx:0)+step;
      ctx.fillText(header,x,baseY); ctx.strokeText(header,x,baseY);
      ctx.restore();
    })(o);

    // Gu√≠a
    const txt=(function(){
      const sel=ghostSelect.value;
      if(sel==='__none__' || !ghostShow.checked) return '';
      return sel==='__custom__' ? (ghostText.value||'').trim() : sel;
    })();
    if(txt){
      const fontPx=(+ghostSize.value)*DPR;
      o.font=`normal ${fontPx}px "EscolarG", system-ui, sans-serif`;
      o.textBaseline='alphabetic';
      o.fillStyle='rgba(17,24,39,.28)';
      o.strokeStyle='rgba(107,114,128,.6)';
      o.lineWidth=Math.max(1,Math.round(fontPx*0.06));
      const period=step*4.6;
      const baseY=top+2*step+(+(viaIndex.value||2)-1)*period;
      if(inlineWord.checked){
        let x=(marginPx>0?marginPx:0)+step;
        for(const ch of txt){ o.fillText(ch,x,baseY); o.strokeText(ch,x,baseY); x+=o.measureText(ch).width+fontPx*0.12; }
      }else{
        const total=o.measureText(txt).width;
        o.fillText(txt,(A4.w-total)/2,baseY); o.strokeText(txt,(A4.w-total)/2,baseY);
      }
    }

    // Trazos
    const strokes=history.flat();
    strokes.forEach(s=>{
      o.save(); o.globalCompositeOperation=s.mode;
      if(s.path.length===1){
        const p=s.path[0]; o.beginPath(); o.arc(p.x,p.y,(s.size/2),0,Math.PI*2); o.fillStyle=s.color; o.fill();
      }else{
        o.beginPath();
        for(let i=0;i<s.path.length-1;i++){
          const a=s.path[i], b=s.path[i+1];
          if(i===0) o.moveTo(a.x,a.y);
          o.quadraticCurveTo(a.x,a.y,(a.x+b.x)/2,(a.y+b.y)/2);
        }
        o.lineWidth=s.size; o.strokeStyle=s.color; o.stroke();
      }
      o.restore();
    });

    // Agujeros
    (function(ctx){
      const pitch=mm2px(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pitch-mm'))||12);
      const holeR=mm2px(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--holeD-mm'))||4.2)/2;
      const offset=mm2px(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--offset-mm'))||5.0);
      const side=ringSideSel.value;
      const topPad=mm2px(12);
      const cx = (side==='left') ? offset : (A4.w - offset);

      // troquel
      ctx.save();
      ctx.globalCompositeOperation='destination-out';
      for(let y=topPad; y<=A4.h-topPad; y+=pitch){
        ctx.beginPath(); ctx.arc(cx,y,holeR,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();

      // borde + vi√±eteado
      for(let y=topPad; y<=A4.h-topPad; y+=pitch){
        ctx.beginPath(); ctx.arc(cx,y,Math.max(holeR-0.25*DPR,0),0,Math.PI*2);
        ctx.lineWidth=0.75*DPR; ctx.strokeStyle='rgba(0,0,0,.45)'; ctx.globalAlpha=0.35; ctx.stroke();
        const gr=ctx.createRadialGradient(cx,y, holeR*0.55, cx,y, holeR);
        gr.addColorStop(0,'rgba(0,0,0,0)'); gr.addColorStop(1,'rgba(0,0,0,.08)');
        ctx.beginPath(); ctx.arc(cx,y,holeR,0,Math.PI*2); ctx.fillStyle=gr; ctx.fill();
      }
    })(o);

    o.restore(); // salir del clip
    return off;
  }

  // Exportar
  savePngBtn.onclick=async()=>{ await waitEscolar(); const off=composeToCanvas(); const a=document.createElement('a'); a.href=off.toDataURL('image/png'); a.download='pauta-trazos.png'; a.click(); };
  printPdfBtn.onclick=async()=>{
    await waitEscolar();
    const off=composeToCanvas(), url=off.toDataURL('image/png');
    const w=window.open('', '_blank'); if(!w) return;
    w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8">
      <title>Imprimir ‚Äî Pauta</title>
      <style>
        @page { size: A4; margin: 0; }
        html,body{ height:100%; margin:0; }
        .page{ width:210mm; height:297mm; display:flex; align-items:center; justify-content:center; }
        img{ width:210mm; height:297mm; }
        @media print { .hint{ display:none } }
        body{ background:#fff }
      </style>
    </head><body>
      <div class="page"><img src="${url}" alt="Pauta A4"></div>
      <div class="hint" style="text-align:center;padding:8px;font-family:sans-serif;color:#666">
        Usa ¬´Guardar como PDF¬ª para exportar en A4, sin m√°rgenes.
      </div>
      <script>window.onload=function(){ setTimeout(()=>window.print(), 100); }<\/script>
    </body></html>`);
    w.document.close();
  };

  // Eventos y arranque
  function redrawAll(){ drawPauta(); drawGuide(); redrawDrawLayer(); }
  [stepSel,margenSel,colorSel,showPauta,showGrid].forEach(el=>el.addEventListener('change',()=>{clampView(); redrawAll();}));
  redrawBtn.onclick=()=>{clampView(); redrawAll();};
  ghostSelect.addEventListener('change',()=>{
    const v=ghostSelect.value;
    ghostText.style.display=(v==='__custom__')?'inline-block':'none';
    ghostShow.checked=(v!=='__none__'); clampView(); redrawAll();
  });
  [ghostText,ghostSize,ghostShow,inlineWord,viaIndex].forEach(el=>el.addEventListener('input',()=>{clampView(); redrawAll();}));
  ringSideSel.addEventListener('change', ()=>{clampView(); redrawAll();});

  (async ()=>{
    cvs.forEach(cv=>{ cv.width=A4.w; cv.height=A4.h; cv.style.width=px2css(A4.w); cv.style.height=px2css(A4.h); });
    paper.style.width=px2css(A4.w); paper.style.height=px2css(A4.h);
    clampView();
    await waitEscolar();
    redrawAll();
  })();
  window.addEventListener('resize', ()=>{ cvs.forEach(cv=>{ cv.width=A4.w; cv.height=A4.h; cv.style.width=px2css(A4.w); cv.style.height=px2css(A4.h); }); clampView(); redrawAll(); }, {passive:true});
})();
</script>
</body>
</html>