<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Pauta Lamela ‚Äî pr√°ctica de trazos</title>

<!-- Preload de la fuente para evitar FOUT -->
<link rel="preload" href="escolar_G.woff2" as="font" type="font/woff2" crossorigin>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>'>

<style>
  /* === Fuente escolar === */
  @font-face{
    font-family: 'EscolarG';
    src: url('escolar_G.woff2') format('woff2');
    font-display: swap;
  }

  :root{
    --ink:#111; --panel:#fff; --border:#d1d5db; --bg:#f3f4f6;
    --sec:#3b82f6; --base:#ef4444; --margin:#10b981;
    --toolbar-bg:#ffffffcc; --toolbar-border:#e5e7eb; --shadow:0 6px 20px rgba(0,0,0,.12);
    --pill:#f8fafc; --pill-border:#e5e7eb; --pill-hover:#eef2ff;
  }

  *{box-sizing:border-box}

  body{
    margin:0;background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    min-height:100vh;display:flex;flex-direction:column;
  }

  /* ===== Toolbar estilo app ===== */
  header.toolbar{
    position:sticky; top:8px; z-index:10;
    margin:8px auto 8px; /* centrado */
    max-width:1200px; width:calc(100% - 16px);
    background:var(--toolbar-bg); backdrop-filter:saturate(1.2) blur(6px);
    border:1px solid var(--toolbar-border);
    border-radius:14px;
    box-shadow:var(--shadow);
    padding:.5rem .75rem;
    display:flex; gap:.75rem; align-items:center; overflow-x:auto;
    scrollbar-width:thin;
  }
  header.toolbar::-webkit-scrollbar{height:8px}
  header.toolbar::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:999px}

  .tgroup{
    display:flex; align-items:center; gap:.5rem;
    padding-inline:.25rem; position:relative;
  }
  /* separadores entre grupos */
  .tgroup + .tgroup{
    margin-left:.25rem;
  }
  .tgroup + .tgroup::before{
    content:""; position:absolute; left:-.375rem; top:6px; bottom:6px;
    width:1px; background:linear-gradient(to bottom, transparent, #e5e7eb, transparent);
  }

  label{font-size:.85rem;color:#374151; white-space:nowrap}

  select,input[type="text"]{
    border:1px solid var(--pill-border); border-radius:999px;
    padding:.35rem .65rem; background:var(--pill);
    font-size:.9rem; outline:none;
  }
  input[type="range"]{width:120px}
  button{
    border:1px solid var(--pill-border); border-radius:999px;
    background:var(--pill); padding:.45rem .7rem; cursor:pointer;
    transition:background .15s ease, transform .02s ease;
  }
  button:hover{background:var(--pill-hover)}
  button:active{transform:translateY(1px)}

  /* Icon-buttons m√°s compactos */
  .icon{padding:.45rem .6rem; min-width:2.2rem}

  /* Contenido */
  main{
    flex:1 1 auto;display:flex;justify-content:center;align-items:flex-start;
    overflow:auto;padding:8px;
  }
  .paper{
    position:relative;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
    box-shadow:0 4px 16px rgba(0,0,0,.10);
    transform-origin: top left; /* zoom/pan */
    touch-action: none;         /* pan controlado */
  }

  canvas{position:absolute; top:0; left:0; touch-action:none}
  #spiralCanvas{z-index:0; pointer-events:none;}
  #pautaCanvas{ z-index:1; pointer-events:none; border-radius:12px; }
  #drawCanvas { z-index:2; border-radius:12px; }
  #ghostCanvas{ z-index:3; pointer-events:none; border-radius:12px; }
</style>
</head>
<body>

<header class="toolbar" role="toolbar" aria-label="Barra de herramientas de pr√°ctica">
  <!-- Archivo -->
  <div class="tgroup" aria-label="Archivo">
    <button id="savePng" class="icon" title="Guardar PNG">üíæ</button>
    <button id="printPdf" class="icon" title="Imprimir / PDF">üñ®Ô∏è</button>
    <button id="clear" class="icon" title="Limpiar">üóëÔ∏è</button>
  </div>

  <!-- Edici√≥n -->
  <div class="tgroup" aria-label="Edici√≥n">
    <label>Herramienta</label>
    <select id="tool">
      <option value="pen" selected>‚úèÔ∏è L√°piz</option>
      <option value="eraser">ü©π Goma</option>
    </select>
    <label>Grosor</label>
    <input id="penSize" type="range" min="1" max="16" value="4" />
    <button id="undo" class="icon" title="Deshacer">‚Ü∂</button>
    <button id="redo" class="icon" title="Rehacer">‚Ü∑</button>
  </div>

  <!-- Pauta -->
  <div class="tgroup" aria-label="Pauta">
    <label>Paso</label>
    <select id="pautaStep">
      <option value="2.5">2.5 mm</option>
      <option value="3">3 mm</option>
      <option value="4" selected>4 mm</option>
    </select>
    <label>Margen</label>
    <select id="margenSel">
      <option value="0">Sin margen</option>
      <option value="10">10 mm</option>
      <option value="15" selected>15 mm</option>
    </select>
    <label>Color</label>
    <select id="colorPauta">
      <option value="clasica">Cl√°sica</option>
      <option value="suave" selected>Suave</option>
      <option value="alto">Alto contraste</option>
    </select>
    <label><input type="checkbox" id="showPauta" checked/> Pauta</label>
    <label><input type="checkbox" id="showGrid" checked/> Cuadr√≠cula</label>
    <button id="redraw" class="icon" title="Redibujar">üîÑ</button>
  </div>

  <!-- Gu√≠a -->
  <div class="tgroup" aria-label="Gu√≠a">
    <label>Letra</label>
    <select id="ghostSelect">
      <optgroup label="Min√∫sculas">
        <option>a</option><option>b</option><option>c</option><option>d</option><option>e</option>
        <option>f</option><option>g</option><option>h</option><option>i</option><option>j</option>
        <option>k</option><option>l</option><option>m</option><option>n</option><option>√±</option>
        <option>o</option><option>p</option><option>q</option><option>r</option><option>s</option>
        <option>t</option><option>u</option><option>v</option><option>w</option><option>x</option>
        <option>y</option><option>z</option>
      </optgroup>
      <optgroup label="May√∫sculas">
        <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option>
        <option>F</option><option>G</option><option>H</option><option>I</option><option>J</option>
        <option>K</option><option>L</option><option>M</option><option>N</option><option>√ë</option>
        <option>O</option><option>P</option><option>Q</option><option>R</option><option>S</option>
        <option>T</option><option>U</option><option>V</option><option>W</option><option>X</option>
        <option>Y</option><option>Z</option>
      </optgroup>
      <optgroup label="Opciones">
        <option value="__custom__">Libre (texto)</option>
        <option value="__none__">Ocultar gu√≠a</option>
      </optgroup>
    </select>
    <input id="ghostText" type="text" placeholder="Escribe aqu√≠‚Ä¶" style="display:none;width:12rem" />
    <label>Tama√±o</label>
    <input id="ghostSize" type="range" min="40" max="300" value="80" />
    <label>V√≠a</label>
    <select id="viaIndex">
      <option value="1">1¬™</option>
      <option value="2" selected>2¬™</option>
      <option value="3">3¬™</option>
      <option value="4">4¬™</option>
      <option value="5">5¬™</option>
    </select>
    <label><input type="checkbox" id="ghostShow" checked/> Mostrar</label>
    <label><input type="checkbox" id="inlineWord" checked/> Palabra en l√≠nea</label>
  </div>

  <!-- Anilla -->
  <div class="tgroup" aria-label="Anilla">
    <label><input type="checkbox" id="showSpiral" checked/> Anilla</label>
    <label>Lado</label>
    <select id="spiralSide">
      <option value="left" selected>Izquierda</option>
      <option value="right">Derecha</option>
    </select>
  </div>

  <!-- Vista (Zoom/Pan) -->
  <div class="tgroup" aria-label="Vista">
    <button id="zoomIn" class="icon" title="Acercar">Ôºã</button>
    <button id="zoomOut" class="icon" title="Alejar">Ôºç</button>
    <button id="zoomReset" class="icon" title="Restablecer vista">‚ü≤</button>
    <label><input type="checkbox" id="panMode" /> üëã Pan</label>
  </div>
</header>

<main>
  <div id="paper" class="paper">
    <canvas id="spiralCanvas"></canvas>
    <canvas id="pautaCanvas"></canvas>
    <canvas id="drawCanvas"></canvas>
    <canvas id="ghostCanvas"></canvas>
  </div>
</main>

<script>
(()=>{
  // ====== Utilidades ======
  const DPR = Math.max(1, window.devicePixelRatio||1);
  const mm2px = mm => mm*96/25.4*DPR;
  const px2css = px => (px/DPR)+'px';
  const A4 = { w:mm2px(210), h:mm2px(297) };
  const SPIRAL_W = mm2px(10);

  // Fecha autom√°tica
  function formatTodayEs(){
    return new Intl.DateTimeFormat('es-ES',{day:'numeric', month:'long', year:'numeric'}).format(new Date());
  }
  function getHeaderText(){ return `Granada ‚Äî ${formatTodayEs()}`; }

  // ====== Carga fiable de la fuente escolar (evita FOUT) ======
  let escolarReadyPromise = null;
  function waitEscolar() {
    if (!escolarReadyPromise) {
      if (document.fonts && document.fonts.load) {
        escolarReadyPromise = Promise.all([
          document.fonts.load('16px "EscolarG"'),
          document.fonts.ready
        ]).catch(()=>{});
      } else {
        escolarReadyPromise = new Promise(r=>setTimeout(r, 200));
      }
    }
    return escolarReadyPromise;
  }

  // ====== Elementos ======
  const paper=document.getElementById('paper');
  const pauta=document.getElementById('pautaCanvas');
  const draw=document.getElementById('drawCanvas');
  const ghost=document.getElementById('ghostCanvas');
  const spiral=document.getElementById('spiralCanvas');
  const cvs=[pauta,draw,ghost];

  // Controles
  const stepSel=document.getElementById('pautaStep');
  const margenSel=document.getElementById('margenSel');
  const colorSel=document.getElementById('colorPauta');
  const showPauta=document.getElementById('showPauta');
  const showGrid=document.getElementById('showGrid');
  const redrawBtn=document.getElementById('redraw');
  const ghostSelect=document.getElementById('ghostSelect');
  const ghostText=document.getElementById('ghostText');
  const ghostSize=document.getElementById('ghostSize');
  const ghostShow=document.getElementById('ghostShow');
  const inlineWord=document.getElementById('inlineWord');
  const viaIndex=document.getElementById('viaIndex');
  const showSpiral=document.getElementById('showSpiral');
  const spiralSide=document.getElementById('spiralSide');
  const toolSel=document.getElementById('tool');
  const penSize=document.getElementById('penSize');
  const undoBtn=document.getElementById('undo');
  const redoBtn=document.getElementById('redo');
  const clearBtn=document.getElementById('clear');
  const savePngBtn=document.getElementById('savePng');
  const printPdfBtn=document.getElementById('printPdf');

  // Vista (Zoom/Pan)
  const zoomInBtn=document.getElementById('zoomIn');
  const zoomOutBtn=document.getElementById('zoomOut');
  const zoomResetBtn=document.getElementById('zoomReset');
  const panMode=document.getElementById('panMode');

  // ====== Paletas ======
  function palette(mode){
    if(mode==='suave') return {base:'#f87171', sec:'#93c5fd', margin:'#22c55e'};
    if(mode==='alto')  return {base:'#dc2626', sec:'#1d4ed8', margin:'#16a34a'};
    return {base:'#ef4444', sec:'#3b82f6', margin:'#10b981'};
  }

  // ====== Tama√±os y colocaci√≥n ======
  function resizeA4(){
    cvs.forEach(cv=>{
      cv.width=A4.w; cv.height=A4.h;
      cv.style.width=px2css(A4.w); cv.style.height=px2css(A4.h);
    });
    paper.style.width=px2css(A4.w);
    paper.style.height=px2css(A4.h);

    // anilla fuera de la hoja
    spiral.width=SPIRAL_W; spiral.height=A4.h;
    spiral.style.width=px2css(SPIRAL_W);
    spiral.style.height=px2css(A4.h);
    spiral.style.left=(spiralSide.value==='left')?px2css(-SPIRAL_W):px2css(A4.w);
  }

  // ====== Pauta Lamela + Cuadr√≠cula vertical ======
  function strokeH(ctx,y,w,c){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(A4.w,y); ctx.lineWidth=w; ctx.strokeStyle=c; ctx.stroke(); }
  function strokeV(ctx,x,w,c){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,A4.h); ctx.lineWidth=w; ctx.strokeStyle=c; ctx.stroke(); }

  function drawGridVertical(ctx, step, marginPx, secColor){
    if(!showGrid.checked) return;
    ctx.save();
    ctx.globalAlpha = 0.15; // tenue
    ctx.lineWidth = Math.max(0.75*DPR, 0.5*DPR);
    // Empieza exactamente en la l√≠nea de margen
    let x = Math.max(0, marginPx);
    while(x < A4.w - 1){
      strokeV(ctx, x, ctx.lineWidth, secColor);
      x += step;
    }
    ctx.restore();
  }

  function drawPauta(){
    const ctx=pauta.getContext('2d');
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,pauta.width,pauta.height);

    // fondo hoja
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,pauta.width,pauta.height);

    const step=mm2px(parseFloat(stepSel.value));
    const top=20*DPR;
    const period=step*4.6;
    const marginPx=mm2px(parseFloat(margenSel.value)||0);
    const {base,sec,margin}=palette(colorSel.value);

    // datos para gu√≠a
    pauta.dataset.topPad=String(top);
    pauta.dataset.step=String(step);
    pauta.dataset.period=String(period);
    pauta.dataset.margin=String(marginPx);

    // cuadr√≠cula vertical (debajo de horizontales)
    drawGridVertical(ctx, step, marginPx, sec);

    if(!showPauta.checked) return;

    // patr√≥n Lamela
    let y=top;
    while(y<pauta.height-top){
      strokeH(ctx,y,1*DPR,sec); y+=step;        // ascendente
      strokeH(ctx,y,1*DPR,sec); y+=step;        // techo
      strokeH(ctx,y,1.5*DPR,base); y+=step;     // base (roja)
      strokeH(ctx,y,1*DPR,sec); y+=step*1.6;    // descendente + espacio
    }

    // margen
    if(marginPx>0){
      ctx.beginPath(); ctx.moveTo(marginPx,0); ctx.lineTo(marginPx,pauta.height);
      ctx.lineWidth=2*DPR; ctx.strokeStyle=margin; ctx.stroke();
    }
  }

  // ====== Anilla (fuera de la hoja) ======
  function drawSpiralCanvas(){
    const ctx=spiral.getContext('2d');
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,spiral.width,spiral.height);
    if(!showSpiral.checked) return;

    const side=spiralSide.value;
    const holeR=mm2px(3.2), pitch=mm2px(18), stripW=mm2px(10), topPad=mm2px(12);

    const xStrip=(side==='left')?(spiral.width-stripW):0;
    const xCenter=(side==='left')?(xStrip+stripW-holeR*0.9):(xStrip+holeR*0.9);

    ctx.fillStyle='#f5f5f5';
    ctx.fillRect(xStrip,0,stripW,spiral.height);

    ctx.fillStyle='rgba(0,0,0,.06)';
    if(side==='left') ctx.fillRect(xStrip+stripW-2*DPR,0,2*DPR,spiral.height);
    else ctx.fillRect(xStrip,0,2*DPR,spiral.height);

    ctx.fillStyle='#d1d5db'; ctx.strokeStyle='#9ca3af'; ctx.lineWidth=1*DPR;
    for(let y=topPad;y<=spiral.height-topPad;y+=pitch){
      ctx.beginPath(); ctx.arc(xCenter,y,holeR,0,Math.PI*2); ctx.fill(); ctx.stroke();
      // alambre (detalle)
      ctx.beginPath(); const wireR=holeR*0.55;
      ctx.arc(xCenter+(side==='left'?-holeR*0.25:holeR*0.25),y,wireR,-Math.PI/2,Math.PI/2);
      ctx.strokeStyle='#6b7280'; ctx.stroke();
    }
  }

  // ====== Gu√≠a (cabecera autom√°tica + texto de pr√°ctica) ======
  function currentGuideText(){
    const sel=ghostSelect.value;
    if(!ghostShow.checked || sel==='__none__') return '';
    if(sel==='__custom__') return (ghostText.value||'').trim();
    return sel;
  }
  function firstBaseLineY(){
    const top = parseFloat(pauta.dataset.topPad || 20*DPR);
    const step= parseFloat(pauta.dataset.step   || mm2px(parseFloat(stepSel.value)));
    return top + 2*step; // 1¬™ base roja
  }
  function baseLineForGuide(){
    const step   = parseFloat(pauta.dataset.step   || mm2px(parseFloat(stepSel.value)));
    const period = parseFloat(pauta.dataset.period || step*4.6);
    const idx    = parseInt(viaIndex.value || '2', 10); // por defecto 2¬™
    return firstBaseLineY() + (idx - 1) * period;
  }
  function marginXpx(){ return parseFloat(pauta.dataset.margin || mm2px(parseFloat(margenSel.value)||0)); }

  // Helpers de alineaci√≥n horizontal (dejar 1 cuadro libre)
  function stepPx(){ return parseFloat(pauta.dataset.step || mm2px(parseFloat(stepSel.value))); }
  function startTextX(){
    const m = marginXpx();
    return (m > 0 ? m : 0) + stepPx(); // ‚¨ÖÔ∏è un cuadro entero desde el margen
  }

  function drawHeaderLine(ctx){
    const header=getHeaderText();
    const fontPx=Math.max(48*DPR, parseInt(ghostSize.value,10)*0.55*DPR);
    ctx.save();
    ctx.font = `normal ${fontPx}px "EscolarG", system-ui, sans-serif`;
    ctx.textBaseline='alphabetic';
    ctx.fillStyle='rgba(17,24,39,.40)';
    ctx.strokeStyle='rgba(107,114,128,.55)';
    ctx.lineWidth=Math.max(1,Math.round(fontPx*0.06));
    const baseY = firstBaseLineY();
    let x = startTextX();                // ‚¨ÖÔ∏è deja el primer cuadro libre
    ctx.fillText(header, x, baseY);
    ctx.strokeText(header, x, baseY);
    ctx.restore();
  }

  function drawGuide(){
    const ctx=ghost.getContext('2d');
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,ghost.width,ghost.height);

    // 1) Cabecera en la 1¬™ v√≠a
    drawHeaderLine(ctx);

    // 2) Texto de pr√°ctica
    const txt=currentGuideText(); if(!txt) return;

    const fontPx=parseInt(ghostSize.value,10)*DPR;
    ctx.font = `normal ${fontPx}px "EscolarG", system-ui, sans-serif`;
    ctx.textBaseline='alphabetic';
    ctx.fillStyle='rgba(17,24,39,.28)';
    ctx.strokeStyle='rgba(107,114,128,.6)';
    ctx.lineWidth=Math.max(1,Math.round(fontPx*0.06));

    const baseY=baseLineForGuide();

    if(inlineWord.checked){
      let x = startTextX();              // ‚¨ÖÔ∏è deja el primer cuadro libre
      for(const ch of txt){
        ctx.fillText(ch, x, baseY);
        ctx.strokeText(ch, x, baseY);
        x += ctx.measureText(ch).width + fontPx*0.12;
      }
    }else{
      const total=ctx.measureText(txt).width;
      ctx.fillText(txt, (A4.w-total)/2, baseY);
      ctx.strokeText(txt, (A4.w-total)/2, baseY);
    }
  }

  // ====== Dibujo libre + Historial ======
  const dctx=draw.getContext('2d'); dctx.lineCap='round'; dctx.lineJoin='round';
  let drawing=false, points=[];
  const history=[]; let redoStack=[];

  function setComposite(){ dctx.globalCompositeOperation=(toolSel.value==='eraser')?'destination-out':'source-over'; }

  function pointerPos(e){
    const r=draw.getBoundingClientRect();
    return {x:(e.clientX-r.left)*DPR, y:(e.clientY-r.top)*DPR};
  }
  function startDraw(e){
    if (panMode.checked) return; // no dibujar en modo pan
    e.preventDefault(); drawing=true; redoStack.length=0;
    points=[pointerPos(e)];
    dctx.save(); setComposite();
    dctx.lineWidth=parseFloat(penSize.value)*DPR;
    dctx.strokeStyle='#111';
    // punto inicial
    dctx.beginPath(); dctx.arc(points[0].x,points[0].y,dctx.lineWidth/2,0,Math.PI*2); dctx.fill();
  }
  function moveDraw(e){
    if(!drawing || panMode.checked) return;
    const p = pointerPos(e);
    const prev = points[points.length-1];
    points.push(p);
    dctx.beginPath();
    const mx=(prev.x+p.x)/2, my=(prev.y+p.y)/2;
    dctx.quadraticCurveTo(prev.x,prev.y,mx,my);
    dctx.stroke();
  }
  function endDraw(){
    if(!drawing) return;
    drawing=false;
    history.push([{
      mode: dctx.globalCompositeOperation,
      size: dctx.lineWidth,
      color:'#111',
      path: points.slice()
    }]);
    dctx.restore();
  }
  function redrawDrawLayer(){
    dctx.setTransform(1,0,0,1,0,0);
    dctx.clearRect(0,0,draw.width,draw.height);
    const strokes = history.flat();
    strokes.forEach(s=>{
      dctx.save();
      dctx.globalCompositeOperation=s.mode;
      dctx.lineWidth=s.size;
      dctx.strokeStyle=s.color;
      if(s.path.length===1){
        const p=s.path[0];
        dctx.beginPath(); dctx.arc(p.x,p.y,dctx.lineWidth/2,0,Math.PI*2); dctx.fill();
      }else{
        dctx.beginPath();
        for(let i=0;i<s.path.length-1;i++){
          const a=s.path[i], b=s.path[i+1];
          const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
          if(i===0) dctx.moveTo(a.x,a.y);
          dctx.quadraticCurveTo(a.x,a.y,mx,my);
        }
        dctx.stroke();
      }
      dctx.restore();
    });
  }
  function undo(){ if(!history.length) return; redoStack.push(history.pop()); redrawDrawLayer(); }
  function redo(){ if(!redoStack.length) return; history.push(redoStack.pop()); redrawDrawLayer(); }
  function clearDraw(){ history.length=0; redoStack.length=0; redrawDrawLayer(); }

  ['pointerdown','pointermove','pointerup','pointercancel','pointerleave'].forEach(ev=>{
    draw.addEventListener(ev, e=>{
      if(ev==='pointerdown') startDraw(e);
      else if(ev==='pointermove') moveDraw(e);
      else endDraw();
    }, {passive:false});
  });
  toolSel.addEventListener('change', setComposite);

  // ====== Exportar (incluye cuadr√≠cula si est√° activada; NO anilla) ======
  function composeToCanvas(){
    const off=document.createElement('canvas'); off.width=A4.w; off.height=A4.h;
    const o=off.getContext('2d');

    // fondo
    o.fillStyle='#fff'; o.fillRect(0,0,off.width,off.height);

    // pauta + cuadr√≠cula
    const step  = mm2px(parseFloat(stepSel.value));
    const top   = 20*DPR;
    const {base, sec, margin} = palette(colorSel.value);
    const marginPx = mm2px(parseFloat(margenSel.value)||0);

    // cuadr√≠cula vertical (tenue) ‚Äî empieza en el margen
    if(showGrid.checked){
      o.save();
      o.globalAlpha=0.15;
      o.lineWidth=Math.max(0.75*DPR,0.5*DPR);
      let x=Math.max(0,marginPx);
      while(x<A4.w-1){ strokeV(o,x,o.lineWidth,sec); x+=step; }
      o.restore();
    }

    if(showPauta.checked){
      let y=top;
      while(y<A4.h-top){
        strokeH(o,y,1*DPR,sec); y+=step;
        strokeH(o,y,1*DPR,sec); y+=step;
        strokeH(o,y,1.5*DPR,base); y+=step;
        strokeH(o,y,1*DPR,sec); y+=step*1.6;
      }
      if(marginPx>0){
        o.beginPath(); o.moveTo(marginPx,0); o.lineTo(marginPx,A4.h);
        o.lineWidth=2*DPR; o.strokeStyle=margin; o.stroke();
      }
    }

    // cabecera (1¬™ v√≠a) ‚Äî ‚¨ÖÔ∏è un cuadro desde el margen
    (function drawHeaderToExport(ctx){
      const baseY = top + 2*step;
      const header = getHeaderText();
      const fontPx=Math.max(48*DPR, parseInt(ghostSize.value,10)*0.55*DPR);
      ctx.save();
      ctx.font = `normal ${fontPx}px "EscolarG", system-ui, sans-serif`;
      ctx.textBaseline='alphabetic';
      ctx.fillStyle='rgba(17,24,39,.40)';
      ctx.strokeStyle='rgba(107,114,128,.55)';
      ctx.lineWidth=Math.max(1,Math.round(fontPx*0.06));
      let x = (marginPx > 0 ? marginPx : 0) + step; // ‚¨ÖÔ∏è cuadro entero
      ctx.fillText(header, x, baseY);
      ctx.strokeText(header, x, baseY);
      ctx.restore();
    })(o);

    // gu√≠a de pr√°ctica ‚Äî ‚¨ÖÔ∏è un cuadro desde el margen (si va en l√≠nea)
    const fontPx=parseInt(ghostSize.value,10)*DPR;
    const txt=currentGuideText();
    if(txt){
      o.font = `normal ${fontPx}px "EscolarG", system-ui, sans-serif`;
      o.textBaseline='alphabetic';
      o.fillStyle='rgba(17,24,39,.28)';
      o.strokeStyle='rgba(107,114,128,.6)';
      o.lineWidth=Math.max(1,Math.round(fontPx*0.06));
      const period=step*4.6;
      const baseY = top + 2*step + (parseInt(viaIndex.value||'2',10)-1)*period;
      if(inlineWord.checked){
        let x = (marginPx > 0 ? marginPx : 0) + step; // ‚¨ÖÔ∏è cuadro entero
        for(const ch of txt){
          o.fillText(ch, x, baseY);
          o.strokeText(ch, x, baseY);
          x += o.measureText(ch).width + fontPx*0.12;
        }
      }else{
        const total=o.measureText(txt).width;
        o.fillText(txt, (A4.w-total)/2, baseY);
        o.strokeText(txt, (A4.w-total)/2, baseY);
      }
    }

    // trazos
    const strokes = history.flat();
    strokes.forEach(s=>{
      o.save();
      o.globalCompositeOperation=s.mode;
      o.lineWidth=s.size;
      o.strokeStyle=s.color;
      if(s.path.length===1){
        const p=s.path[0];
        o.beginPath(); o.arc(p.x,p.y,o.lineWidth/2,0,Math.PI*2); o.fill();
      }else{
        o.beginPath();
        for(let i=0;i<s.path.length-1;i++){
          const a=s.path[i], b=s.path[i+1];
          const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
          if(i===0) o.moveTo(a.x,a.y);
          o.quadraticCurveTo(a.x,a.y,mx,my);
        }
        o.stroke();
      }
      o.restore();
    });

    return off;
  }

  // Exportar (espera la fuente)
  savePngBtn.onclick = async ()=>{
    await waitEscolar();
    const off=composeToCanvas();
    const a=document.createElement('a');
    a.href=off.toDataURL('image/png');
    a.download='pauta-trazos.png';
    a.click();
  };

  printPdfBtn.onclick = async ()=>{
    await waitEscolar();
    const off=composeToCanvas();
    const url=off.toDataURL('image/png');
    const w = window.open('', '_blank');
    if(!w) return;
    w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8">
      <title>Imprimir ‚Äî Pauta</title>
      <style>
        @page { size: A4; margin: 0; }
        html,body{ height:100%; margin:0; }
        .page{ width:210mm; height:297mm; display:flex; align-items:center; justify-content:center; }
        img{ width:210mm; height:297mm; }
        @media print { .hint{ display:none } }
        body{ background:#fff }
      </style>
    </head><body>
      <div class="page"><img src="${url}" alt="Pauta A4"></div>
      <div class="hint" style="text-align:center;padding:8px;font-family:sans-serif;color:#666">
        Usa ¬´Guardar como PDF¬ª para exportar en A4, sin m√°rgenes.
      </div>
      <script>window.onload=function(){ setTimeout(()=>window.print(), 100); }<\/script>
    </body></html>`);
    w.document.close();
  };

  // ====== Vista: Zoom & Pan (solo visual; export no cambia) ======
  let viewScale=1, viewX=0, viewY=0;
  function applyView(){
    paper.style.transform = `translate(${viewX}px, ${viewY}px) scale(${viewScale})`;
  }
  function zoomBy(factor, centerX=null, centerY=null){
    const prevScale = viewScale;
    const newScale = Math.min(4, Math.max(0.3, viewScale * factor));
    if (newScale === prevScale) return;
    if (centerX!==null && centerY!==null){
      viewX = centerX - (centerX - viewX) * (newScale/prevScale);
      viewY = centerY - (centerY - viewY) * (newScale/prevScale);
    }
    viewScale = newScale;
    applyView();
  }
  zoomInBtn.onclick = ()=> zoomBy(1.15, window.innerWidth/2, 200);
  zoomOutBtn.onclick= ()=> zoomBy(1/1.15, window.innerWidth/2, 200);
  zoomResetBtn.onclick=()=>{ viewScale=1; viewX=0; viewY=0; applyView(); };

  // Pan con arrastre
  let panning=false, panStart={x:0,y:0}, viewStart={x:0,y:0};
  paper.addEventListener('pointerdown', e=>{
    if(!panMode.checked) return;
    panning=true;
    panStart={x:e.clientX, y:e.clientY};
    viewStart={x:viewX, y:viewY};
    paper.setPointerCapture(e.pointerId);
    e.preventDefault();
  });
  paper.addEventListener('pointermove', e=>{
    if(!panning) return;
    const dx=e.clientX-panStart.x;
    const dy=e.clientY-panStart.y;
    viewX=viewStart.x+dx;
    viewY=viewStart.y+dy;
    applyView();
  });
  const endPan= e=>{ if(!panning) return; panning=false; try{paper.releasePointerCapture(e.pointerId);}catch{} };
  paper.addEventListener('pointerup', endPan);
  paper.addEventListener('pointercancel', endPan);
  paper.addEventListener('pointerleave', endPan);

  // Ctrl + rueda = zoom
  document.addEventListener('wheel', e=>{
    if(!e.ctrlKey) return;
    e.preventDefault();
    const factor = e.deltaY>0 ? 1/1.08 : 1.08;
    zoomBy(factor, e.clientX, e.clientY);
  }, {passive:false});

  // ====== Redibujado global ======
  function redrawAll(){ drawPauta(); drawGuide(); redrawDrawLayer(); drawSpiralCanvas(); }

  // ====== Eventos ======
  [stepSel,margenSel,colorSel,showPauta,showGrid].forEach(el=>el.addEventListener('change', redrawAll));
  redrawBtn.onclick=redrawAll;

  ghostSelect.addEventListener('change',()=>{
    const v=ghostSelect.value;
    ghostText.style.display=(v==='__custom__')?'inline-block':'none';
    if(v==='__none__'){ ghostShow.checked=false; } else { ghostShow.checked=true; }
    redrawAll();
  });
  [ghostText,ghostSize,ghostShow,inlineWord,viaIndex].forEach(el=>el.addEventListener('input', redrawAll));

  clearBtn.onclick = clearDraw;
  undoBtn.onclick  = undo;
  redoBtn.onclick  = redo;

  [showSpiral, spiralSide].forEach(el=>{
    el.addEventListener('change', ()=>{
      spiral.style.left = (spiralSide.value==='left') ? px2css(-SPIRAL_W) : px2css(A4.w);
      drawSpiralCanvas();
    });
  });

  // ====== Init (espera a la fuente y luego pinta) ======
  (async ()=>{
    resizeA4();
    await waitEscolar();   // asegura EscolarG cargada
    redrawAll();           // primer dibujado ya con la fuente correcta
    applyView();
  })();

  window.addEventListener('resize', ()=>{ resizeA4(); redrawAll(); }, {passive:true});

})();
</script>
</body>
</html>