<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Pauta Lamela ‚Äî pr√°ctica de trazos</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>'>
<style>
  @font-face {
    font-family: 'EscolarG';
    src: url('escolar_G.woff2') format('woff2');
    font-display: swap;
  }

  :root{
    --ink:#111; --panel:#fff; --border:#d1d5db; --bg:#f3f4f6;
    --sec:#3b82f6; --base:#ef4444; --margin:#10b981;
  }
  body{
    margin:0;background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    min-height:100vh;display:flex;flex-direction:column;
  }

  header{
    flex:0 0 auto;background:#fff;border-bottom:1px solid var(--border);
    padding:.6rem .8rem;display:flex;flex-wrap:wrap;gap:.6rem 1rem;align-items:center;
    overflow-x:auto;position:sticky;top:0;z-index:10;
  }
  header .group{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
  label{font-size:.9rem;color:#374151}
  select,input[type="text"]{
    border:1px solid var(--border);border-radius:.5rem;padding:.35rem .5rem;background:#fff
  }
  input[type="range"]{width:120px}
  button{border:1px solid var(--border);border-radius:.5rem;background:#fff;padding:.45rem .65rem;cursor:pointer}
  button:active{transform:translateY(1px)}

  main{
    flex:1 1 auto;display:flex;justify-content:center;align-items:flex-start;
    overflow:auto;padding:8px;
  }
  .paper{
    position:relative;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
    box-shadow:0 4px 16px rgba(0,0,0,.10);
  }

  canvas{position:absolute; top:0; left:0; touch-action:none}
  #spiralCanvas{z-index:0; pointer-events:none; border-radius:0;}
  #pautaCanvas{ z-index:1; pointer-events:none; border-radius:12px; }
  #drawCanvas { z-index:2; border-radius:12px; }
  #ghostCanvas{ z-index:3; pointer-events:none; border-radius:12px; }
</style>
</head>
<body>
<header>
  <div class="group">
    <button id="savePng">üíæ PNG</button>
    <button id="printPdf">üñ®Ô∏è Imprimir / PDF</button>
    <button id="clear">üóëÔ∏è Limpiar</button>
  </div>
  <div class="group">
    <label>Herramienta:</label>
    <select id="tool">
      <option value="pen" selected>‚úèÔ∏è L√°piz</option>
      <option value="eraser">ü©π Goma</option>
    </select>
    <label>Grosor:</label>
    <input id="penSize" type="range" min="1" max="16" value="4" />
    <button id="undo" title="Deshacer">‚Ü∂</button>
    <button id="redo" title="Rehacer">‚Ü∑</button>
  </div>
  <div class="group">
    <label>Pauta:</label>
    <select id="pautaStep">
      <option value="2.5">2.5 mm</option>
      <option value="3" selected>3 mm</option>
      <option value="4">4 mm</option>
    </select>
    <label>Margen:</label>
    <select id="margenSel">
      <option value="0">Sin margen</option>
      <option value="10">10 mm</option>
      <option value="15" selected>15 mm</option>
    </select>
    <label>Color:</label>
    <select id="colorPauta">
      <option value="clasica" selected>Cl√°sica</option>
      <option value="suave">Suave</option>
      <option value="alto">Alto contraste</option>
    </select>
    <label><input type="checkbox" id="showPauta" checked/> Mostrar pauta</label>
    <button id="redraw">üîÑ Redibujar</button>
  </div>
  <div class="group">
    <label>Letra:</label>
    <select id="ghostSelect">
      <optgroup label="Min√∫sculas"><option>a</option><option>b</option><option>c</option>‚Ä¶</optgroup>
      <optgroup label="May√∫sculas"><option>A</option><option>B</option><option>C</option>‚Ä¶</optgroup>
      <optgroup label="Opciones">
        <option value="__custom__">Libre (texto)</option>
        <option value="__none__">Ocultar gu√≠a</option>
      </optgroup>
    </select>
    <input id="ghostText" type="text" placeholder="Escribe aqu√≠‚Ä¶" style="display:none;width:12rem" />
    <label>Tama√±o:</label>
    <input id="ghostSize" type="range" min="40" max="300" value="160" />
    <label>V√≠a:</label>
    <select id="viaIndex"><option value="1">1¬™</option><option value="2" selected>2¬™</option><option value="3">3¬™</option></select>
    <label><input type="checkbox" id="ghostShow" checked/> Mostrar</label>
    <label><input type="checkbox" id="inlineWord" checked/> Palabra en l√≠nea</label>
    <label><input type="checkbox" id="animateGuide" /> Trazos animados</label>
  </div>
  <div class="group">
    <button id="zoomIn">Ôºã</button><button id="zoomOut">Ôºç</button><button id="zoomReset">100%</button>
    <button id="panHand">‚úã Mano</button>
    <button id="panLeft">‚¨ÖÔ∏è</button><button id="panUp">‚¨ÜÔ∏è</button><button id="panDown">‚¨áÔ∏è</button><button id="panRight">‚û°Ô∏è</button>
    <button id="centerToMargin">üìè Ir a margen</button>
  </div>
  <div class="group">
    <label><input type="checkbox" id="showSpiral" checked/> Mostrar anilla</label>
    <label>Lado:</label>
    <select id="spiralSide"><option value="left" selected>Izquierda</option><option value="right">Derecha</option></select>
  </div>
</header>

<main>
  <div id="paper" class="paper">
    <canvas id="spiralCanvas"></canvas>
    <canvas id="pautaCanvas"></canvas>
    <canvas id="drawCanvas"></canvas>
    <canvas id="ghostCanvas"></canvas>
  </div>
</main>

<script>
(()=>{
  const DPR = Math.max(1, window.devicePixelRatio||1);
  const mm2px = mm => mm*96/25.4*DPR;
  const px2css = px => (px/DPR)+'px';
  const A4 = { w:mm2px(210), h:mm2px(297) };
  const SPIRAL_STRIP_W_MM = 10;
  const SPIRAL_W = mm2px(SPIRAL_STRIP_W_MM);

  const paper = document.getElementById('paper');
  const pauta = document.getElementById('pautaCanvas');
  const draw  = document.getElementById('drawCanvas');
  const ghost = document.getElementById('ghostCanvas');
  const spiral= document.getElementById('spiralCanvas');
  const cvs=[pauta,draw,ghost];

  // === Estado y controles abreviados ===
  const toolSel=document.getElementById('tool'), penSize=document.getElementById('penSize');
  const stepSel=document.getElementById('pautaStep'), margenSel=document.getElementById('margenSel'), colorSel=document.getElementById('colorPauta');
  const showPauta=document.getElementById('showPauta'), redrawBtn=document.getElementById('redraw');
  const ghostSelect=document.getElementById('ghostSelect'), ghostText=document.getElementById('ghostText'), ghostSize=document.getElementById('ghostSize');
  const ghostShow=document.getElementById('ghostShow'), inlineWord=document.getElementById('inlineWord'), animateGuide=document.getElementById('animateGuide');
  const viaIndex=document.getElementById('viaIndex');
  const showSpiral=document.getElementById('showSpiral'), spiralSide=document.getElementById('spiralSide');
  const savePngBtn=document.getElementById('savePng'), printPdfBtn=document.getElementById('printPdf');
  const clearBtn=document.getElementById('clear'), undoBtn=document.getElementById('undo'), redoBtn=document.getElementById('redo');

  const view={scale:1,tx:0,ty:0,hand:false};

  // === Resize A4 + anilla ===
  function resizeA4(){
    cvs.forEach(cv=>{cv.width=A4.w;cv.height=A4.h;cv.style.width=px2css(A4.w);cv.style.height=px2css(A4.h);});
    paper.style.width=px2css(A4.w); paper.style.height=px2css(A4.h);
    spiral.width=SPIRAL_W; spiral.height=A4.h; spiral.style.width=px2css(SPIRAL_W); spiral.style.height=px2css(A4.h);
    if(spiralSide.value==='left'){spiral.style.left=px2css(-SPIRAL_W);}else{spiral.style.left=px2css(A4.w);}
  }

  function drawSpiralCanvas(){
    const ctx=spiral.getContext('2d'); ctx.clearRect(0,0,spiral.width,spiral.height);
    if(!showSpiral.checked) return;
    const holeR=mm2px(3.2), pitch=mm2px(18), stripW=mm2px(10), inset=0, topPad=mm2px(12);
    const xStrip=(spiralSide.value==='left')?(spiral.width-stripW-inset):inset;
    const xCenter=(spiralSide.value==='left')?xStrip+stripW-holeR*0.9:xStrip+holeR*0.9;
    ctx.fillStyle='#f5f5f5';ctx.fillRect(xStrip,0,stripW,spiral.height);
    ctx.fillStyle='rgba(0,0,0,.06)';
    if(spiralSide.value==='left') ctx.fillRect(xStrip+stripW-2*DPR,0,2*DPR,spiral.height); else ctx.fillRect(xStrip,0,2*DPR,spiral.height);
    ctx.fillStyle='#d1d5db'; ctx.strokeStyle='#9ca3af'; ctx.lineWidth=1*DPR;
    for(let y=topPad;y<=spiral.height-topPad;y+=pitch){
      ctx.beginPath();ctx.arc(xCenter,y,holeR,0,Math.PI*2);ctx.fill();ctx.stroke();
      ctx.beginPath();const wireR=holeR*0.55;ctx.arc(xCenter+(spiralSide.value==='left'?-holeR*0.25:holeR*0.25),y,wireR,-Math.PI/2,Math.PI/2);ctx.strokeStyle='#6b7280';ctx.stroke();
    }
  }

  function redrawAll(){ drawPauta(); drawGuide(); redrawDrawLayer(); drawSpiralCanvas(); }

  // === Pauta / Gu√≠a / Dibujo‚Ä¶ (id√©nticos a lo que ya tienes) ===
  // ‚ö†Ô∏è Para no desbordar aqu√≠: mant√©n tus funciones drawPauta(), drawGuide(), etc. tal cual.
  // Solo recuerda que ahora la anilla se pinta en drawSpiralCanvas() y no dentro de drawPauta().

  // === Init ===
  resizeA4(); redrawAll();
})();
</script>
</body>
</html>