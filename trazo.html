<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Pauta Lamela — práctica de trazos</title>
<style>
  /* === Fuente escolar === */
  @font-face {
    font-family: 'EscolarG';
    src: url('escolar_G.woff2') format('woff2');
    font-display: swap;
  }

  :root{
    --ink:#111; --panel:#fff; --border:#d1d5db; --bg:#f3f4f6;
    --sec:#3b82f6; --base:#ef4444; --margin:#10b981;
  }
  body{
    margin:0;background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    min-height:100vh;display:flex;flex-direction:column;
  }

  /* Barra de herramientas */
  header{
    flex:0 0 auto;background:#fff;border-bottom:1px solid var(--border);
    padding:.6rem .8rem;display:flex;flex-wrap:wrap;gap:.6rem 1rem;align-items:center;
    overflow-x:auto;position:sticky;top:0;z-index:10;
  }
  header .group{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
  label{font-size:.9rem;color:#374151}
  select,input[type="text"]{
    border:1px solid var(--border);border-radius:.5rem;padding:.35rem .5rem;background:#fff
  }
  input[type="range"]{width:120px}
  button{border:1px solid var(--border);border-radius:.5rem;background:#fff;padding:.45rem .65rem;cursor:pointer}
  button:active{transform:translateY(1px)}

  /* Hoja A4 debajo del header */
  main{
    flex:1 1 auto;display:flex;justify-content:center;align-items:flex-start;
    overflow:auto;padding:8px;
  }
  .paper{
    position:relative;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
    box-shadow:0 4px 16px rgba(0,0,0,.10);
  }
  canvas{position:absolute; top:0; left:0; touch-action:none; border-radius:12px}
  #pautaCanvas{ z-index:1; pointer-events:none; }
  #drawCanvas { z-index:2; }
  #ghostCanvas{ z-index:3; pointer-events:none; }
</style>
</head>
<body>
<header>
  <!-- Archivo -->
  <div class="group">
    <button id="savePng">💾 PNG</button>
    <button id="printPdf">🖨️ Imprimir / PDF</button>
    <button id="clear">🗑️ Limpiar</button>
  </div>

  <!-- Edición -->
  <div class="group">
    <label>Herramienta:</label>
    <select id="tool">
      <option value="pen" selected>✏️ Lápiz</option>
      <option value="eraser">🩹 Goma</option>
    </select>
    <label>Grosor:</label>
    <input id="penSize" type="range" min="1" max="16" value="4" />
    <button id="undo" title="Deshacer">↶</button>
    <button id="redo" title="Rehacer">↷</button>
  </div>

  <!-- Pauta -->
  <div class="group">
    <label>Pauta:</label>
    <select id="pautaStep">
      <option value="2.5">2.5 mm</option>
      <option value="3" selected>3 mm</option>
      <option value="4">4 mm</option>
    </select>
    <label>Margen:</label>
    <select id="margenSel">
      <option value="0">Sin margen</option>
      <option value="10">10 mm</option>
      <option value="15" selected>15 mm</option>
    </select>
    <label>Color:</label>
    <select id="colorPauta">
      <option value="clasica" selected>Clásica</option>
      <option value="suave">Suave</option>
      <option value="alto">Alto contraste</option>
    </select>
    <label><input type="checkbox" id="showPauta" checked/> Mostrar pauta</label>
    <button id="redraw">🔄 Redibujar</button>
  </div>

  <!-- Guía -->
  <div class="group">
    <label>Letra:</label>
    <select id="ghostSelect">
      <optgroup label="Minúsculas">
        <option>a</option><option>b</option><option>c</option> ... <!-- etc -->
      </optgroup>
      <optgroup label="Mayúsculas">
        <option>A</option><option>B</option><option>C</option> ... <!-- etc -->
      </optgroup>
      <optgroup label="Opciones">
        <option value="__custom__">Libre (texto)</option>
        <option value="__none__">Ocultar guía</option>
      </optgroup>
    </select>
    <input id="ghostText" type="text" placeholder="Escribe aquí…" style="display:none;width:12rem" />
    <label>Tamaño:</label>
    <input id="ghostSize" type="range" min="40" max="300" value="160" />
    <label><input type="checkbox" id="ghostShow" checked/> Mostrar</label>
    <label><input type="checkbox" id="inlineWord" checked/> Palabra en línea</label>
    <label><input type="checkbox" id="animateGuide" /> Trazos animados</label>
  </div>

  <!-- Vista -->
  <div class="group">
    <button id="zoomIn">＋</button>
    <button id="zoomOut">－</button>
    <button id="zoomReset">100%</button>
    <button id="panHand">✋ Mano</button>
    <button id="panLeft">⬅️</button>
    <button id="panUp">⬆️</button>
    <button id="panDown">⬇️</button>
    <button id="panRight">➡️</button>
    <button id="centerToMargin">📏 Ir a margen</button>
  </div>
</header>

<main>
  <div id="paper" class="paper">
    <canvas id="pautaCanvas"></canvas>
    <canvas id="drawCanvas"></canvas>
    <canvas id="ghostCanvas"></canvas>
  </div>
</main>

<script>
(()=>{
  const DPR = Math.max(1, window.devicePixelRatio||1);
  const mm2px = mm => mm*96/25.4*DPR;
  const px2css = px => (px/DPR)+'px';
  const A4 = { w:mm2px(210), h:mm2px(297) };

  const paper = document.getElementById('paper');
  const pauta = document.getElementById('pautaCanvas');
  const draw  = document.getElementById('drawCanvas');
  const ghost = document.getElementById('ghostCanvas');
  const cvs=[pauta,draw,ghost];

  function resizeA4(){
    cvs.forEach(cv=>{
      cv.width  = A4.w;
      cv.height = A4.h;
      cv.style.width  = px2css(A4.w);
      cv.style.height = px2css(A4.h);
    });
    paper.style.width  = px2css(A4.w);
    paper.style.height = px2css(A4.h);
    redrawAll();
  }
  window.addEventListener('resize', resizeA4, {passive:true});

  // Estado de vista
  const view = { scale: 1, tx: 0, ty: 0, hand:false };
  let draggingView=false, lastPan={x:0,y:0}; // 👈 Declaración única aquí

  function applyView(ctx){ ctx.setTransform(view.scale,0,0,view.scale, view.tx, view.ty); }
  function screenToWorld(xCss, yCss){
    const x = xCss*DPR, y = yCss*DPR;
    return { x: (x - view.tx)/view.scale, y: (y - view.ty)/view.scale };
  }
  function zoomBy(factor, cxCss, cyCss){
    const before = screenToWorld(cxCss, cyCss);
    view.scale = Math.min(4, Math.max(0.5, view.scale*factor));
    const after = screenToWorld(cxCss, cyCss);
    view.tx += (before.x - after.x)*view.scale;
    view.ty += (before.y - after.y)*view.scale;
    redrawAll();
  }
  function panBy(dxCss, dyCss){ view.tx += dxCss*DPR; view.ty += dyCss*DPR; redrawAll(); }

  // ... ⚡ resto del código exactamente igual que el que ya tenías, 
  // con funciones drawPauta(), drawGuide(), dibujo libre, undo/redo, export, etc.
  // (lo único que he quitado es la segunda declaración duplicada de `draggingView` y `lastPan`)

  // ====== Init ======
  showPauta.checked = true;
  resizeA4();
  ghostSelect.value='a'; ghostShow.checked=true; inlineWord.checked=true;
  setComposite();
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(()=>{ redrawAll(); });
  } else {
    redrawAll();
  }
  animateGuide.checked=false;
})();
</script>
</body>
</html>